<!doctype html>
<html lang="en">

    <head>

		<!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <title>nidl</title>
        
        <!-- CSS -->
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500&display=swap">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
        <link rel="stylesheet" href="../_static/css/jquery.mCustomScrollbar.min.css">
        <link rel="stylesheet" href="../_static/css/animate.css">
        <link rel="stylesheet" href="../_static/css/style.css">
        <link rel="stylesheet" href="../_static/css/jquery.mosaic.css">
        <link rel="stylesheet" href="../_static/sg_gallery.css">
        <link rel="stylesheet" href="../_static/css/media-queries.css">
        <link rel="stylesheet" href="../_static/css/pygment.css">

        <!-- Favicon and touch icons -->
        <link rel="shortcut icon" href="../_static/ico/favicon.png">
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../_static/ico/apple-touch-icon-144-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../_static/ico/apple-touch-icon-114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../_static/ico/apple-touch-icon-72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" href="../_static/ico/apple-touch-icon-57-precomposed.png">

    </head>

    <body>

		<!-- Wrapper -->
    	<div class="wrapper">

			<!-- Sidebar -->
			<nav class="sidebar">
				
				<!-- close sidebar menu -->
				<div class="dismiss">
					<i class="fas fa-arrow-left"></i>
				</div>
				
				<!-- <div class="logo"">
					<h3><a href="../index.html">Sidebar Menu</a></h3>
				</div> -->

                <!-- info setup -->
                    <p class="doc-version">
                        This documentation is for nidl <strong>version 0.0.0</strong>
                    </p>
                <p class="citing">
                    If you use the software, please do not hesitate to 
                    <a &mdash; <a href="https://github.com/neurospin-deepinsight/nidl">
                    Report a Bug</a>.
                </p>
				
                <!-- links -->
                
                
                    
                
				<ul class="list-unstyled menu-elements">
					<li class="active">
						<a href="../index.html"><i class="fas fa-home"></i> Home</a>
					</li>
					<li>
						<a href="../generated/installation.html"><i class="fas fa-cog"></i> Installation</a>
					</li>
					<li>
						<a href="index.html"><i class="fas fa-eye"></i> Gallery</a>
					</li>
					<li>
						<a href="../generated/documentation.html"><i class="fas fa-pencil-alt"></i> API documentation</a>
					</li>
					<li>
						<a href="../generated/search.html"><i class="fas fa-search"></i> Search</a>
					</li>
					<!-- <li>
						<a href="https://github.com/AGrigis/pysphinxdoc"><i class="fas fa-external-link-alt"></i> PYSPHINXDOC</a>
					</li> -->
					<!-- <li>
						<a href="#otherSections" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle" role="button" aria-controls="otherSections">
							<i class="fas fa-sync"></i>Sections Shortcuts
						</a>
						<ul class="collapse list-unstyled" id="otherSections">
                            <li>LINKS</li><li><a href='https://github.com/neurospin-deepinsight/surfify'>surfify</a></li>
                            
                                
                                
                                    
                                        
                                        
                                        
                                    
                                        
                                        
                                        
                                    
                                        
                                        
                                        
                                            
                                            
                                    
                                
                                    
                                        
                                        
                                        
                                    
                                        
                                        
                                        
                                            
                                            
                                    
                                
                                    
                                        
                                        
                                        
                                    
                                        
                                        
                                        
                                            
                                            
                                    
                                
                                    
                                        
                                        
                                        
                                    
                                        
                                        
                                        
                                            
                                            
                                    
                                
                                    
                                        
                                        
                                        
                                    
                                        
                                        
                                        
                                            
                                            
                                    
                                        
                                        
                                        
                                            
                                            
                                    
                                
                                    
                                        
                                        
                                        
                                    
                                        
                                        
                                        
                                            
                                            
                                    
                                
                                    
                                        
                                        
                                        
                                    
                                
                                    
                                        
                                        
                                        
                                    
                                        
                                        
                                        
                                            
                                            
                                    
                                        
                                        
                                        
                                            
                                            
                                    
                                
                                    
                                        
                                        
                                        
                                    
                                        
                                        
                                        
                                            
                                            
                                    
                                
                                    
                                        
                                        
                                        
                                    
                                
                                    
                                        
                                        
                                        
                                    
                                
                                    
                                        
                                        
                                        
                                    
                                
                                
                                    <li>SECTIONS</li>
                                    
						                <li> <a href='#load-the-packages'>Load The Packages</a> </li>                                    
                                    
						                <li> <a href='#load-the-openbhb-dataset-and-plot-the-modalities'>Load The Openbhb Dataset And Plot The Modalities</a> </li>                                    
                                    
						                <li> <a href='#plot-whole-brain-voxel-based-morphometry-vbm-and-quasi-raw-images'>Plot Whole-Brain Voxel-Based Morphometry (Vbm) And Quasi-Raw Images</a> </li>                                    
                                    
						                <li> <a href='#plot-vbm-roi-on-the-neuromorphometrics-atlas'>Plot Vbm-Roi On The Neuromorphometrics Atlas</a> </li>                                    
                                    
						                <li> <a href='#plot-surface-based-measures-from-freesurfer'>Plot Surface-Based Measures From Freesurfer</a> </li>                                    
                                    
						                <li> <a href='#visualize-regional-measures-on-the-destrieux-atlas'>Visualize Regional Measures On The Destrieux Atlas</a> </li>                                    
                                    
						                <li> <a href='#visualize-fine-grained-measures-on-the-fsaverage7-template'>Visualize Fine-Grained Measures On The Fsaverage7 Template</a> </li>                                    
                                    
						                <li> <a href='#fit-machine-learning-models-for-age-and-sex-prediction'>Fit Machine Learning Models For Age And Sex Prediction</a> </li>                                    
                                    
						                <li> <a href='#age-prediction-with-ridge-regression'>Age Prediction With Ridge Regression</a> </li>                                    
                                    
						                <li> <a href='#sex-classification-with-logistic-regression'>Sex Classification With Logistic Regression</a> </li>                                    
                                    
                                
                            
                            <li>API</li>
                            <li><a href="../generated/nidl.html">nidl</a></li><li><a href="../generated/nidl.callbacks.html">nidl.callbacks</a></li><li><a href="../generated/nidl.datasets.html">nidl.datasets</a></li><li><a href="../generated/nidl.estimators.html">nidl.estimators</a></li><li><a href="../generated/nidl.estimators.autoencoders.html">nidl.estimators.autoencoders</a></li><li><a href="../generated/nidl.estimators.linear.html">nidl.estimators.linear</a></li><li><a href="../generated/nidl.estimators.ssl.html">nidl.estimators.ssl</a></li><li><a href="../generated/nidl.estimators.ssl.utils.html">nidl.estimators.ssl.utils</a></li><li><a href="../generated/nidl.losses.html">nidl.losses</a></li><li><a href="../generated/nidl.metrics.html">nidl.metrics</a></li><li><a href="../generated/nidl.utils.html">nidl.utils</a></li><li><a href="../generated/nidl.volume.html">nidl.volume</a></li><li><a href="../generated/nidl.volume.backbones.html">nidl.volume.backbones</a></li><li><a href="../generated/nidl.volume.transforms.html">nidl.volume.transforms</a></li><li><a href="../generated/nidl.volume.transforms.augmentation.html">nidl.volume.transforms.augmentation</a></li><li><a href="../generated/nidl.volume.transforms.augmentation.intensity.html">nidl.volume.transforms.augmentation.intensity</a></li><li><a href="../generated/nidl.volume.transforms.augmentation.spatial.html">nidl.volume.transforms.augmentation.spatial</a></li><li><a href="../generated/nidl.volume.transforms.preprocessing.html">nidl.volume.transforms.preprocessing</a></li><li><a href="../generated/nidl.volume.transforms.preprocessing.intensity.html">nidl.volume.transforms.preprocessing.intensity</a></li><li><a href="../generated/nidl.volume.transforms.preprocessing.spatial.html">nidl.volume.transforms.preprocessing.spatial</a></li><li><a href="../generated/surfify.html">surfify</a></li><li><a href="../generated/surfify.augmentation.html">surfify.augmentation</a></li><li><a href="../generated/surfify.datasets.html">surfify.datasets</a></li><li><a href="../generated/surfify.losses.html">surfify.losses</a></li><li><a href="../generated/surfify.models.html">surfify.models</a></li><li><a href="../generated/surfify.nn.html">surfify.nn</a></li><li><a href="../generated/surfify.plotting.html">surfify.plotting</a></li><li><a href="../generated/surfify.utils.html">surfify.utils</a></li>
						</ul>
					</li> -->
				</ul>
				
                <!-- go top page -->
				<!-- <div class="to-top">
					<a class="btn btn-primary btn-customized-3" href="#" role="button">
	                    <i class="fas fa-arrow-up"></i> Top
	                </a>
				</div> -->
			
                <!-- change color -->
				<!-- <div class="dark-light-buttons">
					<a class="btn btn-primary btn-customized-4 btn-customized-dark" href="#" role="button">Dark</a>
					<a class="btn btn-primary btn-customized-4 btn-customized-light" href="#" role="button">Light</a>
				</div> -->
			
			</nav>
			<!-- End sidebar -->
			
			<!-- Dark overlay -->
    		<div class="overlay"></div>

			<!-- Content -->
			<div class="content">
			
				<!-- open sidebar menu -->
				<a class="btn btn-primary btn-customized open-menu" href="#" role="button">
                    <i class="fas fa-align-left"></i> <span>Menu</span>
                </a>

		        <!-- Top content -->
		        <div class="top-content section-container" id="top-content">
			        <div class="container">
			            <div class="row">
                            <div class="col-md-3 section-5-box banner-logo">
                                <img alt="Logo" src="../_static/nidl.png">
                            </div>
			                <div class="col-md-7 section-5-box">
			                	<h1 class="wow fadeIn">    <p>Deep learning for NeuroImaging in Python.</p></h1>
			                </div>
			            </div>
			        </div>
		        </div>
                    
                    <div class="document">
                        <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-auto-gallery-openbhb-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="presentation-of-the-openbhb-dataset-and-baseline-models-for-age-and-sex-predictions">
<span id="sphx-glr-auto-gallery-openbhb-py"></span><h1>Presentation of the OpenBHB dataset and baseline models for age and sex predictions<a class="headerlink" href="#presentation-of-the-openbhb-dataset-and-baseline-models-for-age-and-sex-predictions" title="Link to this heading">¶</a></h1><div class='divider-1 wow fadeInUp' style='margin-top: -20px;'><span></span></div>
<p>This notebook introduces the OpenBHB dataset <a class="footnote-reference brackets" href="#id2" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>, a large-scale, multi-site
brain MRI dataset. It is designed to perform benchmarking of machine learning
and deep learning models on neuroimaging data.</p>
<p>We will demonstrate how to use OpenBHB for two important prediction tasks:</p>
<ul class="simple">
<li><p><strong>Age prediction</strong></p></li>
<li><p><strong>Sex classification</strong></p></li>
</ul>
<p>These serve as simple entry points for evaluating model performance and
potential bias across imaging sites.</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id2" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>Dufumier et al., “OpenBHB: a Large-Scale Multi-Site Brain MRI Dataset
for Age Prediction and Debiasing,” NeuroImage, 2022.
<a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S1053811922007522">https://www.sciencedirect.com/science/article/pii/S1053811922007522</a></p>
</aside>
</aside>
<section id="load-the-packages">
<h2 style='border-bottom: 1px solid #d3dbd5'>Load the packages<a class="headerlink" href="#load-the-packages" title="Link to this heading">¶</a></h2>
<p>First, we need to load the packages to run this notebook:</p>
<p>Import packages</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">nibabel</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nilearn</span><span class="w"> </span><span class="kn">import</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">plotting</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span><span class="p">,</span> <span class="n">Ridge</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">accuracy_score</span><span class="p">,</span>
    <span class="n">r2_score</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">nidl.datasets</span><span class="w"> </span><span class="kn">import</span> <a href="../generated/nidl.datasets.OpenBHB.html#nidl.datasets.OpenBHB" title="nidl.datasets.OpenBHB" class="sphx-glr-backref-module-nidl-datasets sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">OpenBHB</span></a>
</pre></div>
</div>
</section>
<section id="load-the-openbhb-dataset-and-plot-the-modalities">
<h2 style='border-bottom: 1px solid #d3dbd5'>Load the OpenBHB dataset and plot the modalities<a class="headerlink" href="#load-the-openbhb-dataset-and-plot-the-modalities" title="Link to this heading">¶</a></h2>
<p>OpenBHB contains 6 modalities (or preprocessed data) of healthy subject
anatomical brains. It contains <img class="math" src="../_images/math/8add29bad4fb285b02dd5661ff937e3586065aad.png" alt="n_{train}=3227"/> training images and
<img class="math" src="../_images/math/2436f8c28658a93a93f4e618ea536c9b0c7b3934.png" alt="n_{val}=757"/> validation images. Demographic information about the
subjects (age, sex) are available along with the details on the acquisition
machines (magnetic field strength, acquisition setting).</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <a href="../generated/nidl.datasets.OpenBHB.html#nidl.datasets.OpenBHB" title="nidl.datasets.OpenBHB" class="sphx-glr-backref-module-nidl-datasets sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">OpenBHB</span></a><span class="p">(</span>
    <span class="n">root</span><span class="o">=</span><span class="s2">&quot;/tmp/openBHB&quot;</span><span class="p">,</span>
    <span class="n">modality</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">&quot;vbm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;quasiraw&quot;</span><span class="p">,</span>
        <span class="s2">&quot;vbm_roi&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fs_desikan_roi&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fs_destrieux_roi&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fs_xhemi&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">target</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="plot-whole-brain-voxel-based-morphometry-vbm-and-quasi-raw-images">
<h2 style='border-bottom: 1px solid #d3dbd5'>Plot whole-brain Voxel-Based Morphometry (VBM) and Quasi-Raw images<a class="headerlink" href="#plot-whole-brain-voxel-based-morphometry-vbm-and-quasi-raw-images" title="Link to this heading">¶</a></h2>
<p>Let’s take a look at the first subject in the dataset. We’ll visualize two
different modalities:</p>
<ul class="simple">
<li><p><strong>VBM</strong> (Voxel-Based Morphometry): gray matter density maps computed using
the CAT12 toolbox. VBM preprocessing involves tissue segmentation, normalization
to MNI space, and modulation, resulting in voxel-wise maps that reflect local gray
matter volume.</p></li>
<li><p><strong>Quasi-Raw</strong>: T1-weighted MRI scans that have been preprocessed with basic
steps like bias correction and skull stripping, but without spatial normalization
or heavy smoothing. The goal is to retain as much of the anatomical detail of the
original scan as possible, providing input that is close to raw data while still
being in the same physical space across subjects.</p></li>
</ul>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">all_mods</span><span class="p">,</span> <span class="n">infos</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Get data from first subject</span>

<span class="c1"># VBM</span>
<span class="n">img_vbm</span> <span class="o">=</span> <span class="n">all_mods</span><span class="p">[</span><span class="s2">&quot;vbm&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># select the first (and only) channel</span>
<span class="n">nii_img</span> <span class="o">=</span> <span class="n">nibabel</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">img_vbm</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">img_vbm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_anat</span><span class="p">(</span><span class="n">nii_img</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;VBM image (infos=</span><span class="si">{</span><span class="n">infos</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="c1"># Quasi-Raw</span>
<span class="n">img_quasiraw</span> <span class="o">=</span> <span class="n">all_mods</span><span class="p">[</span><span class="s2">&quot;quasiraw&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># select the first (and only) channel</span>
<span class="n">nii_img</span> <span class="o">=</span> <span class="n">nibabel</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">img_quasiraw</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_anat</span><span class="p">(</span><span class="n">nii_img</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Quasi-Raw image (infos=</span><span class="si">{</span><span class="n">infos</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="plot-vbm-roi-on-the-neuromorphometrics-atlas">
<h2 style='border-bottom: 1px solid #d3dbd5'>Plot VBM-ROI on the Neuromorphometrics atlas<a class="headerlink" href="#plot-vbm-roi-on-the-neuromorphometrics-atlas" title="Link to this heading">¶</a></h2>
<p>In this visualization, we map <strong>regional gray matter volumes (VBM-ROI)</strong> onto
a brain template using the Neuromorphometrics atlas**:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># - The VBM-ROI features are computed by averaging voxel-wise gray matter volumes</span>
<span class="c1">#   within each of the **142 anatomical regions** defined in the atlas.</span>
<span class="c1"># - Each region corresponds to a gray matter structure, and volumes are</span>
<span class="c1">#   extracted independently for each hemisphere.</span>
<span class="c1"># - The resulting brain map shows the **regional gray matter volume in</span>
<span class="c1">#   milliliters (mL)**.</span>


<span class="k">def</span><span class="w"> </span><span class="nf">map_roi_on_neuromorphometrics_atlas</span><span class="p">(</span><span class="n">roi_values</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">atlas</span><span class="p">):</span>
    <span class="c1"># Map ROI values on the Neuromorphometrics atlas</span>
    <span class="n">atlas_data</span> <span class="o">=</span> <span class="n">atlas</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
    <span class="n">atlas_labels</span> <span class="o">=</span> <span class="n">atlas</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span>
    <span class="n">brain_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">atlas_data</span><span class="p">)</span>
    <span class="n">idx_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">atlas_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="n">brain_map</span><span class="p">[</span><span class="n">atlas_data</span> <span class="o">==</span> <span class="n">idx_mapping</span><span class="p">[</span><span class="n">label</span><span class="p">]]</span> <span class="o">=</span> <span class="n">roi_values</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">brain_map</span> <span class="o">=</span> <span class="n">nibabel</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">brain_map</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="n">atlas</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">brain_map</span>


<span class="c1"># Step 1: Select regional gray matter volumes for the first subject</span>
<span class="c1"># first 142 ROI volumes (gray matter only)</span>
<span class="n">vbm_roi</span> <span class="o">=</span> <span class="n">all_mods</span><span class="p">[</span><span class="s2">&quot;vbm_roi&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][:</span><span class="mi">142</span><span class="p">]</span>

<span class="c1"># Step 2: Clean up ROI labels (remove &#39;_GM_Vol&#39; suffix)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_GM_Vol&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_vbm_roi_labels</span><span class="p">()[:</span><span class="mi">142</span><span class="p">]</span>
<span class="p">]</span>

<span class="c1"># Step 3: Load the Neuromorphometrics atlas used for mapping</span>
<span class="n">atlas</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_neuromorphometrics_atlas</span><span class="p">()</span>

<span class="c1"># Step 4: Project the ROI values onto the brain volume using the atlas</span>
<span class="n">brain_map</span> <span class="o">=</span> <span class="n">map_roi_on_neuromorphometrics_atlas</span><span class="p">(</span><span class="n">vbm_roi</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">atlas</span><span class="p">)</span>

<span class="c1"># Step 5: Plot the resulting brain map</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_stat_map</span><span class="p">(</span>
    <span class="n">brain_map</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Regional Gray Matter Volume (mL)&quot;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;plasma&quot;</span><span class="p">,</span>  <span class="c1"># visually appealing sequential colormap</span>
    <span class="n">draw_cross</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="plot-surface-based-measures-from-freesurfer">
<h2 style='border-bottom: 1px solid #d3dbd5'>Plot Surface-Based Measures from FreeSurfer<a class="headerlink" href="#plot-surface-based-measures-from-freesurfer" title="Link to this heading">¶</a></h2>
<p>The OpenBHB dataset includes <strong>surface-based cortical measurements</strong> extracted
using FreeSurfer, such as:</p>
<ul class="simple">
<li><p><strong>Cortical thickness</strong></p></li>
<li><p><strong>Surface area</strong></p></li>
<li><p><strong>Gray matter volume</strong></p></li>
<li><p><strong>Curvature</strong></p></li>
</ul>
<p>These measures are averaged over predefined regions from:</p>
<ul class="simple">
<li><p>The <strong>Desikan-Killiany atlas</strong> (34 cortical regions per hemisphere)</p></li>
<li><p>The <strong>Destrieux atlas</strong> (74 cortical regions per hemisphere, excluding the
medial wall)</p></li>
</ul>
<p>Each value represents a regional summary of the surface geometry or morphology
of the cortex. In addition, OpenBHB provides <strong>xhemi</strong> (cross-hemisphere) data
computed on the fsaverage7 template (163842 vertices), which merges homologous
regions across both hemispheres. This allows for analysis that reduces hemispheric
asymmetries and improves statistical power by combining left and right hemisphere
information.</p>
<p>In the following, we will define a small utility function to map these regional
values onto the standard FreeSurfer surface (fsaverage5) for visualization of
Desikan and Destrieux-based measures. For the xhemi data, which is computed
on the higher-resolution fsaverage7 surface, visualization can be done similarly
but requires using the corresponding fsaverage7 mesh files.</p>
<section id="visualize-regional-measures-on-the-destrieux-atlas">
<h3>Visualize regional measures on the Destrieux atlas<a class="headerlink" href="#visualize-regional-measures-on-the-destrieux-atlas" title="Link to this heading">¶</a></h3>
<p>We start by visualizing the regional measures based on the Destrieux atlas.
The following function maps the regional values onto the fsaverage5 surface
for visualization.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">map_freesurfer_destrieux_data</span><span class="p">(</span><span class="n">roi_values</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">hemi</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">):</span>
    <span class="c1"># Load Destrieux atlas</span>
    <span class="n">fsaverage</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">fetch_atlas_surf_destrieux</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">fs_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">fsaverage</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]]</span>
    <span class="n">map_hemi</span> <span class="o">=</span> <span class="n">fsaverage</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;map_</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

    <span class="c1"># Map ROI values to vertex-wise data using the labels</span>
    <span class="n">idx_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">fs_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">}</span>
    <span class="n">vertex_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">map_hemi</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">roi_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="n">vertex_data</span><span class="p">[</span><span class="n">map_hemi</span> <span class="o">==</span> <span class="n">idx_mapping</span><span class="p">[</span><span class="n">roi_name</span><span class="p">]]</span> <span class="o">=</span> <span class="n">roi_values</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">vertex_data</span>


<span class="c1"># Load the correct channel index for the features</span>
<span class="n">surface_area</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_fs_roi_feature_names</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;surface_area_mm^2&quot;</span><span class="p">)</span>
<span class="n">volume</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_fs_roi_feature_names</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;gray_matter_volume_mm^3&quot;</span><span class="p">)</span>
<span class="n">thickness</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_fs_roi_feature_names</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;average_thickness_mm&quot;</span><span class="p">)</span>
<span class="n">curvature</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_fs_roi_feature_names</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
    <span class="s2">&quot;integrated_rectified_mean_curvature_mm^-1&quot;</span>
<span class="p">)</span>
<span class="c1"># Load the ROI data</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_fs_labels</span><span class="p">(</span><span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fs_surface</span> <span class="o">=</span> <span class="n">all_mods</span><span class="p">[</span><span class="s2">&quot;fs_destrieux_roi&quot;</span><span class="p">][</span><span class="n">surface_area</span><span class="p">]</span>
<span class="n">fs_volume</span> <span class="o">=</span> <span class="n">all_mods</span><span class="p">[</span><span class="s2">&quot;fs_destrieux_roi&quot;</span><span class="p">][</span><span class="n">volume</span><span class="p">]</span>
<span class="n">fs_thickness</span> <span class="o">=</span> <span class="n">all_mods</span><span class="p">[</span><span class="s2">&quot;fs_destrieux_roi&quot;</span><span class="p">][</span><span class="n">thickness</span><span class="p">]</span>
<span class="n">fs_curv</span> <span class="o">=</span> <span class="n">all_mods</span><span class="p">[</span><span class="s2">&quot;fs_destrieux_roi&quot;</span><span class="p">][</span><span class="n">curvature</span><span class="p">]</span>
<span class="c1"># Map the ROI on the Destrieux surfacic atlas</span>
<span class="n">surface_vertex</span> <span class="o">=</span> <span class="n">map_freesurfer_destrieux_data</span><span class="p">(</span><span class="n">fs_surface</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<span class="n">volume_vertex</span> <span class="o">=</span> <span class="n">map_freesurfer_destrieux_data</span><span class="p">(</span><span class="n">fs_volume</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<span class="n">thickness_vertex</span> <span class="o">=</span> <span class="n">map_freesurfer_destrieux_data</span><span class="p">(</span><span class="n">fs_thickness</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<span class="n">curv_vertex</span> <span class="o">=</span> <span class="n">map_freesurfer_destrieux_data</span><span class="p">(</span><span class="n">fs_curv</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

<span class="c1"># Prepare plots</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">surface_vertex</span><span class="p">,</span> <span class="n">volume_vertex</span><span class="p">,</span> <span class="n">thickness_vertex</span><span class="p">,</span> <span class="n">curv_vertex</span><span class="p">]</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Surface area ($mm^2$)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GM volume ($mm^3$)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cortical thickness ($mm$)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mean curvature ($mm^{-1}$)&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">fsaverage</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">fetch_surf_fsaverage</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="s2">&quot;fsaverage5&quot;</span><span class="p">)</span>
<span class="n">inflated_left</span> <span class="o">=</span> <span class="n">fsaverage</span><span class="p">[</span><span class="s2">&quot;infl_left&quot;</span><span class="p">]</span>
<span class="n">sulc_left</span> <span class="o">=</span> <span class="n">fsaverage</span><span class="p">[</span><span class="s2">&quot;sulc_left&quot;</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="s2">&quot;3d&quot;</span><span class="p">}</span>
<span class="p">)</span>
<span class="c1"># Plot each measurement</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">titles</span><span class="p">):</span>
    <span class="n">plotting</span><span class="o">.</span><span class="n">plot_surf</span><span class="p">(</span>
        <span class="n">inflated_left</span><span class="p">,</span>
        <span class="n">surf_map</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span>
        <span class="n">hemi</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="n">view</span><span class="o">=</span><span class="s2">&quot;lateral&quot;</span><span class="p">,</span>
        <span class="n">bg_map</span><span class="o">=</span><span class="n">sulc_left</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;plasma&quot;</span><span class="p">,</span>
        <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
        <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span>
    <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="visualize-fine-grained-measures-on-the-fsaverage7-template">
<h3>Visualize fine-grained measures on the fsaverage7 template<a class="headerlink" href="#visualize-fine-grained-measures-on-the-fsaverage7-template" title="Link to this heading">¶</a></h3>
<p>Next, we visualize more fine-grained FreeSurfer surface features on
the left hemisphere using the higher-resolution fsaverage7 template:</p>
<ul class="simple">
<li><p><cite>lh.curv</cite>: Mean curvature map of the cortical surface, reflecting folding
patterns (arbitrary unit, negative=sulci, positive=gyri).</p></li>
<li><p><cite>lh.sulc</cite>: Sulcal depth map, indicating the depth of sulci (cortical folds),
in millimiter.</p></li>
<li><p><cite>lh.thickness</cite>: Cortical thickness values at each vertex (in millimiter).</p></li>
</ul>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the correct channels for xhemi</span>
<span class="n">thickness</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_fs_xhemi_feature_names</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;lh.thickness&quot;</span><span class="p">)</span>
<span class="n">sulc</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_fs_xhemi_feature_names</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;lh.sulc&quot;</span><span class="p">)</span>
<span class="n">curv</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_fs_xhemi_feature_names</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;lh.curv&quot;</span><span class="p">)</span>
<span class="c1"># Load the xhemi data</span>
<span class="n">fs_thickness</span> <span class="o">=</span> <span class="n">all_mods</span><span class="p">[</span><span class="s2">&quot;fs_xhemi&quot;</span><span class="p">][</span><span class="n">thickness</span><span class="p">]</span>
<span class="n">fs_sulc</span> <span class="o">=</span> <span class="n">all_mods</span><span class="p">[</span><span class="s2">&quot;fs_xhemi&quot;</span><span class="p">][</span><span class="n">sulc</span><span class="p">]</span>
<span class="n">fs_curv</span> <span class="o">=</span> <span class="n">all_mods</span><span class="p">[</span><span class="s2">&quot;fs_xhemi&quot;</span><span class="p">][</span><span class="n">curv</span><span class="p">]</span>
<span class="c1"># Get fsaverage7 template</span>
<span class="n">fsaverage</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">fetch_surf_fsaverage</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="s2">&quot;fsaverage7&quot;</span><span class="p">)</span>
<span class="n">infl_left</span> <span class="o">=</span> <span class="n">fsaverage</span><span class="p">[</span><span class="s2">&quot;infl_left&quot;</span><span class="p">]</span>
<span class="n">sulc_left</span> <span class="o">=</span> <span class="n">fsaverage</span><span class="p">[</span><span class="s2">&quot;sulc_left&quot;</span><span class="p">]</span>

<span class="c1"># Prepare plots</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">fs_thickness</span><span class="p">,</span> <span class="n">fs_sulc</span><span class="p">,</span> <span class="n">fs_curv</span><span class="p">]</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Cortical thickness (in $mm$)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Sulcal depth (in $mm$)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curvature&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="s2">&quot;3d&quot;</span><span class="p">})</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">titles</span><span class="p">):</span>
    <span class="n">plotting</span><span class="o">.</span><span class="n">plot_surf</span><span class="p">(</span>
        <span class="n">infl_left</span><span class="p">,</span>
        <span class="n">surf_map</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span>
        <span class="n">hemi</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="n">bg_map</span><span class="o">=</span><span class="n">sulc_left</span><span class="p">,</span>
        <span class="n">darkness</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;plasma&quot;</span><span class="p">,</span>
        <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
        <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="fit-machine-learning-models-for-age-and-sex-prediction">
<h2 style='border-bottom: 1px solid #d3dbd5'>Fit machine learning models for age and sex prediction<a class="headerlink" href="#fit-machine-learning-models-for-age-and-sex-prediction" title="Link to this heading">¶</a></h2>
<p>Now that we have explored the different modalities in OpenBHB, we will
demonstrate how to use them to fit simple machine learning models on two
standard benchmarking tasks: age prediction (regression) and sex
classification.
We will compare three representations of the brain:</p>
<ul class="simple">
<li><p>the <strong>VBM-ROI</strong> features, which provides regional gray matter volumes based
on the Neuromorphometrics atlas,</p></li>
<li><p>the <strong>Desikan-based SBM ROI</strong> features, which provide surface-based
measures in 68 cortical regions,</p></li>
<li><p>the <strong>Destrieux-based SBM ROI</strong> features, which provide surface-based
measures in 148 cortical regions.</p></li>
</ul>
<p>We start by loading all the relevant datasets for these tasks:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">modalities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;vbm_roi&quot;</span><span class="p">,</span> <span class="s2">&quot;fs_desikan_roi&quot;</span><span class="p">,</span> <span class="s2">&quot;fs_destrieux_roi&quot;</span><span class="p">]</span>

<span class="n">modality_names</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;vbm_roi&quot;</span><span class="p">:</span> <span class="s2">&quot;VBM-Neuromorphometrics&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fs_desikan_roi&quot;</span><span class="p">:</span> <span class="s2">&quot;SBM-Desikan&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fs_destrieux_roi&quot;</span><span class="p">:</span> <span class="s2">&quot;SBM-Destrieux&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">dataset_train</span> <span class="o">=</span> <a href="../generated/nidl.datasets.OpenBHB.html#nidl.datasets.OpenBHB" title="nidl.datasets.OpenBHB" class="sphx-glr-backref-module-nidl-datasets sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">OpenBHB</span></a><span class="p">(</span>
    <span class="s2">&quot;/tmp/openBHB&quot;</span><span class="p">,</span>
    <span class="n">modality</span><span class="o">=</span><span class="n">modalities</span><span class="p">,</span>
    <span class="n">target</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">],</span>
    <span class="n">split</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">,</span>
    <span class="n">streaming</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">dataset_val</span> <span class="o">=</span> <a href="../generated/nidl.datasets.OpenBHB.html#nidl.datasets.OpenBHB" title="nidl.datasets.OpenBHB" class="sphx-glr-backref-module-nidl-datasets sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">OpenBHB</span></a><span class="p">(</span>
    <span class="s2">&quot;/tmp/openBHB&quot;</span><span class="p">,</span>
    <span class="n">modality</span><span class="o">=</span><span class="n">modalities</span><span class="p">,</span>
    <span class="n">target</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">],</span>
    <span class="n">split</span><span class="o">=</span><span class="s2">&quot;val&quot;</span><span class="p">,</span>
    <span class="n">streaming</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">extract_features_and_targets</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">modalities</span><span class="o">=</span><span class="n">modalities</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract features and target arrays from OpenBHB dataset.&quot;&quot;&quot;</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y_age</span><span class="p">,</span> <span class="n">y_sex</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modalities</span><span class="p">},</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modalities</span><span class="p">:</span>
            <span class="n">X</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="n">y_age</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">])</span>
        <span class="n">y_sex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_age</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_sex</span><span class="p">),</span>
    <span class="p">)</span>


<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_age</span><span class="p">,</span> <span class="n">y_train_sex</span> <span class="o">=</span> <span class="n">extract_features_and_targets</span><span class="p">(</span><span class="n">dataset_train</span><span class="p">)</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">y_test_age</span><span class="p">,</span> <span class="n">y_test_sex</span> <span class="o">=</span> <span class="n">extract_features_and_targets</span><span class="p">(</span><span class="n">dataset_val</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Age range:&quot;</span><span class="p">,</span> <span class="n">y_train_age</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">y_train_age</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sex distribution:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_train_sex</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
</pre></div>
</div>
<section id="age-prediction-with-ridge-regression">
<h3>Age prediction with Ridge regression<a class="headerlink" href="#age-prediction-with-ridge-regression" title="Link to this heading">¶</a></h3>
<p>We will use a Ridge regression model with standard scaling as a baseline
for age prediction. We will evaluate the model using the R² score and visualize
the predicted vs. true ages for the three modalities.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;vbm_roi&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fs_desikan_roi&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:green&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fs_destrieux_roi&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">modality</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">modalities</span><span class="p">):</span>
    <span class="n">ridge_model</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">Ridge</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
    <span class="n">ridge_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">modality</span><span class="p">],</span> <span class="n">y_train_age</span><span class="p">)</span>
    <span class="n">y_pred_age</span> <span class="o">=</span> <span class="n">ridge_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">modality</span><span class="p">])</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test_age</span><span class="p">,</span> <span class="n">y_pred_age</span><span class="p">)</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">y_test_age</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">y_pred_age</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">edgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">modality</span><span class="p">],</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Add reference line y=x</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">y_test_age</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">y_test_age</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">modality_names</span><span class="p">[</span><span class="n">modality</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">R²=</span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;True Age&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Predicted Age&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Age Prediction with Ridge Regression&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="sex-classification-with-logistic-regression">
<h3>Sex classification with logistic regression<a class="headerlink" href="#sex-classification-with-logistic-regression" title="Link to this heading">¶</a></h3>
<p>Next, we will use a logistic regression model with standard scaling as a
baseline for sex classification. We will evaluate the model using accuracy.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">accuracies</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">modality</span> <span class="ow">in</span> <span class="n">modalities</span><span class="p">:</span>
    <span class="n">logreg_model</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
        <span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">logreg_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">modality</span><span class="p">],</span> <span class="n">y_train_sex</span><span class="p">)</span>
    <span class="n">y_pred_sex</span> <span class="o">=</span> <span class="n">logreg_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">modality</span><span class="p">])</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test_sex</span><span class="p">,</span> <span class="n">y_pred_sex</span><span class="p">)</span>
    <span class="n">accuracies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">modality_names</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modalities</span><span class="p">],</span>
    <span class="n">y</span><span class="o">=</span><span class="n">accuracies</span><span class="p">,</span>
    <span class="n">palette</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Modality&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Accuracy&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Sex Classification with Logistic Regression&quot;</span><span class="p">)</span>

<span class="c1"># Add accuracy text above bars</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">acc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">accuracies</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">acc</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">acc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>Observations: the VBM representation gives the best results for both tasks,
indicating that regional gray matter volumes are highly informative for predicting
age and sex. Nevertheless, it would be interesting to check whether combining the
modalities would improve the result, which would mean that they provide complementary
information. This is left as an exercise to the reader.</p>
<p><strong>Estimated memory usage:</strong>  0 MB</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-gallery-openbhb-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/a6e0c7e5033c0d3ed91fd1f7a5037453/openbhb.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">openbhb.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/5ee8e787bfbc3c383e63c4acaced8563/openbhb.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">openbhb.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../_downloads/4b03a8e923ec1e40fcba5299a4a3d24d/openbhb.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">openbhb.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>
</section>

                    </div>
                <div class="spacer"></div>
		        
		        <!-- Footer -->
		        <div class="section-6-container section-container section-container-image-bg" id="section-6">
			        <div class="container">
			            <div class="row">
		                    <div class="col-md-5 offset-md-1 section-6-box wow fadeInDown">
                                <div class="section-6-title">
		                    	    <p>Follow us</p>
                                </div>
		                    	<div class="section-6-social">
			                    	<a href="https://www.facebook.com/pages/NeuroSpin/171075046414933"><i class="fab fa-facebook-f"></i></a>
									<a href="https://www.youtube.com/CEASaclay"><i class="fab fa-youtube"></i></a>
									<a href="https://twitter.com/neurospin_91"><i class="fab fa-twitter"></i></a>
									<a href="https://gaia.neurospin.fr"><i class="fa fa-link"></i></a>
                                    <p>&copy; 2025, 
nidl developers
 <antoine.grigis@cea.fr></p>
		                    	</div>
		                    </div>
			            </div>
			        </div>
                </div>
	        
	        </div>
	        <!-- End content -->
        
        </div>
        <!-- End wrapper -->

        <!-- Javascript -->
		<script src="../_static/js/jquery-3.3.1.min.js"></script>
		<script src="../_static/js/jquery-migrate-3.0.0.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <script src="../_static/js/jquery.backstretch.min.js"></script>
        <script src="../_static/js/wow.min.js"></script>
        <script src="../_static/js/jquery.waypoints.min.js"></script>
        <script src="../_static/js/jquery.mCustomScrollbar.concat.min.js"></script>
        <script src="../_static/js/scripts.js"></script>
        <script src="../_static/js/jquery.mosaic.js"></script>
        <script src="../_static/js/search.js"></script>
        <script type="text/javascript">
	        $('.top-content').backstretch("../_static/img/backgrounds/banner1.png");
            $('.section-6-container').backstretch("../_static/img/backgrounds/footer1.png");
        </script>

    </body>

</html>